generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// prisma/schema.prisma
model User {
  id             String    @id @default(uuid())
  email          String?   @unique
  name           String?
  password       String?   @db.Text
  emailVerified  DateTime?
  image          String?
  credits        Int       @default(3)
  starknetAddress String?
  liskAddress    String?    // Lisk address (e.g., base32 format)
  btcAddress     String?
  ethereumAddress String?   // Ethereum address (0x format)
  runesBalance   String?   // Verified Runes balance
  runesRuneId    String?   // Which Rune they hold
  votingPower    Int       @default(0) // Based on Runes balance
  lastRunesSync  DateTime? // Last balance check
  reputation     Int       @default(0)
  governanceStake String?   @default("0") // Governance stake amount
  role           UserRole  @default(USER)
  isAdmin        Boolean   @default(false)
  adminApprovedBy String?  // ID of admin who approved this user
  adminApprovedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  transactions   Transaction[]
  submissions    Submission[]
  storage        Storage[]
  proposals      Proposal[]
  votes          Vote[]
  ethereumTransfers EthereumTransfer[]
  activities     Activity[]

  @@index([ethereumAddress])
}

model Transaction {
  id          String   @id @default(uuid())
  amount      Decimal
  currency    String
  status      String
  reference   String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
}

model Submission {
  id           String      @id @default(uuid())
  taskId       String
  userId       String
  resultHash   String
  storageUri   String
  liskTxId     String?     // Lisk tx id for reputation / attestation
  status       SubmissionStatus @default(PENDING)
  qualityScore Int?
  rewardAmount String?     // MAD token reward amount
  rewardTxHash String?     // MAD token transaction hash
  rewardError  String?     // Reward error message if any
  metadata     Json?       // Data curation metadata (title, description, tags, etc.)
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
  CHALLENGED
}

model Proposal {
  id              String   @id @default(uuid())
  title           String
  description     String
  proposalType    ProposalType
  proposer        String   // User ID
  startTime       DateTime
  endTime         DateTime
  forVotes        String   @default("0") // Vote count
  againstVotes    String   @default("0")
  executed        Boolean  @default(false)
  status          ProposalStatus @default(ACTIVE)
  metadata        Json?
  createdAt       DateTime @default(now())
  
  votes           Vote[]
  proposerUser    User     @relation(fields: [proposer], references: [id])
}

model Vote {
  id            String   @id @default(uuid())
  proposalId    String
  userId        String
  support       Boolean  // true = for, false = against
  votingPower   Int      // Runes balance at vote time
  btcSignature  String   // Bitcoin signature proof
  createdAt     DateTime @default(now())
  
  proposal      Proposal @relation(fields: [proposalId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  
  @@unique([proposalId, userId])
}

enum ProposalType {
  TREASURY
  GOVERNANCE
  TECHNICAL
  DATA_CURATION
}

enum ProposalStatus {
  ACTIVE
  PASSED
  REJECTED
  EXECUTED
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

model Storage {
  id          String   @id @default(uuid())
  contentHash String   @unique
  filename    String
  mimeType    String
  size        Int
  storageUri  String   @unique
  content     String   @db.Text // Base64 encoded content (temporary)
  userId      String
  submissionId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([contentHash])
  @@index([storageUri])
}

model EthereumTransfer {
  id              String   @id @default(uuid())
  fromAddress     String
  toAddress       String
  amount          Decimal
  transactionHash String   @unique
  blockNumber     Int?
  blockHash       String?
  gasUsed         String?
  gasPrice        String?
  status          String   // pending, confirmed, failed
  eventType       String   // transfer, governance_deposit, governance_withdrawal, reward
  metadata        Json?    // Additional event data
  processed       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  userId          String?
  user            User?    @relation(fields: [userId], references: [id])

  @@index([fromAddress])
  @@index([toAddress])
  @@index([transactionHash])
  @@index([eventType])
  @@index([status])
  @@index([processed])
  @@index([userId])
}

model Activity {
  id          String   @id @default(uuid())
  userId      String
  type        String   // transfer, governance_deposit, governance_withdrawal, reward
  title       String
  description String?
  metadata    Json?    // Additional activity data
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([type])
}
